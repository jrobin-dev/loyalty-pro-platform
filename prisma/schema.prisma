generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// SQLite doesn't support Enums, so we'll handle them as Strings in the application layer
// Role: SUPER_ADMIN, BUSINESS_OWNER, END_USER
// Plan: FREE, PRO, PLUS

model User {
  id        String   @id @default(uuid()) // Links to Supabase Auth ID
  email     String   @unique
  name      String?
  lastName  String?
  phone     String?
  birthday  DateTime?
  avatarUrl String?
  role      String   @default("BUSINESS_OWNER")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  tenants   Tenant[] // Businesses owned
  
  // As End User
  memberships Customer[] // Programs joined
}

model Tenant {
  id          String   @id @default(uuid())
  slug        String   @unique
  name        String
  category    String?
  ownerId     String
  owner       User     @relation(fields: [ownerId], references: [id])
  plan        String   @default("FREE")
  status      String   @default("ACTIVE") // ACTIVE, SUSPENDED, PENDING
  
  branding    Branding?
  loyalty     LoyaltyProgram?
  customers   Customer[]
  transactions StampTransaction[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Branding {
  id             String @id @default(uuid())
  tenantId       String @unique
  tenant         Tenant @relation(fields: [tenantId], references: [id])
  
  primaryColor   String @default("#000000") // Neon Green or Custom
  secondaryColor String @default("#ffffff")
  logoUrl        String?
  fontFamily     String @default("Funnel Display")
  
  gradient       Boolean @default(false)
}

model LoyaltyProgram {
  id             String @id @default(uuid())
  tenantId       String @unique
  tenant         Tenant @relation(fields: [tenantId], references: [id])
  
  stampIcon      String @default("star") 
  stampsRequired Int    @default(6)
  rewardTitle    String @default("Free Reward")
}

model Customer {
  id        String   @id @default(uuid())
  
  userId    String?  
  user      User?    @relation(fields: [userId], references: [id])
  
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  
  totalStamps    Int @default(0)
  currentStamps  Int @default(0)
  
  transactions   StampTransaction[]
  
  joinedAt       DateTime @default(now())
  
  @@unique([userId, tenantId])
}

model StampTransaction {
  id         String   @id @default(uuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])
  
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id])
  
  type       String   // EARNED, REDEEMED
  amount     Float    @default(0)
  stampsEarned Int    @default(1)
  description String?
  
  createdAt  DateTime @default(now())
}



model AcademyCourse {
  id          String   @id @default(uuid())
  title       String
  description String?
  slug        String   @unique
  imageUrl    String?
  published   Boolean  @default(false)
  
  lessons     AcademyLesson[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model AcademyLesson {
  id          String   @id @default(uuid())
  courseId    String
  course      AcademyCourse @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  title       String
  description String?  // Markdown support
  provider    String   // YOUTUBE, BUNNY
  videoId     String   // ID or URL
  duration    String?
  order       Int      @default(0)
  
  comments    AcademyComment[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model AcademyComment {
  id          String   @id @default(uuid())
  content     String
  
  lessonId    String
  lesson      AcademyLesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  userId      String   // User ID (UUID) from Supabase Auth
  userRole    String?  // Store role snapshot if needed, or join with user table if sync'd
  userName    String?  // Store name for display
  userAvatar  String?
  
  parentId    String?
  parent      AcademyComment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies     AcademyComment[] @relation("CommentReplies")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
